name: Install yq
description: Installs mikefarah/yq on the job's runner
author: Daniel Weibel
inputs:
  version:
    description: The version of yq to install (by default, the latest version will be installed)
    required: false
  binary:
    description: The name of the yq binary to install (by default, 'yq_linux_amd64' and 'yq_darwin_amd64' are installed for Linux and macOS runners, respectively)
    required: false
runs:
  using: composite
  steps:

    - name: check-os
      run: |
        if [[ "${{ runner.os }}" = Windows ]]; then
          echo "This action currently does not support Windows runners"
          exit 1
        fi
      shell: bash

    - name: determine-version
      run: |
        VERSION="${{ inputs.version }}"
        if [[ -z "$VERSION" ]]; then
          # Determine latest version
          out=$(wget -q --content-on-error -O - "$GITHUB_API_URL"/repos/mikefarah/yq/releases/latest) || { echo "$out"; exit 1; }
          VERSION=$(echo "$out" | jq -r .tag_name)
        else
          # Verify user-supplied version
          out=$(wget -q --content-on-error -O - "$GITHUB_API_URL"/repos/mikefarah/yq/releases) || { echo "$out"; exit 1; }
          if ! echo "$out" | jq -r '.[].tag_name' | grep -q "^$VERSION$"; then
            echo -e "\"$VERSION\" is not a valid yq version (find valid versions on <https://github.com/mikefarah/yq/releases>)"
            exit 1
          fi
        fi
        echo "VERSION=$VERSION" >>"$GITHUB_ENV"
        echo "Using yq version \"$VERSION\""
      shell: bash

    - name: determine-binary
      run: |
        BINARY="${{ inputs.binary }}"
        if [[ -z "$BINARY" ]]; then
          # Use default binaries
          case "${{ runner.os }}" in
            Linux) BINARY=yq_linux_amd64 ;;
            macOS) BINARY=yq_darwin_amd64 ;;
          esac
        else
          # Verify user-supplied binary
          out=$(wget -q --content-on-error -O - "$GITHUB_API_URL"/repos/mikefarah/yq/releases/tags/"$VERSION") || { echo "$out"; exit 1; }
          if ! echo "$out" | jq -r '.assets[].name' | grep -q "^$BINARY$"; then
            echo -e "\"$BINARY\" is not a valid binary of yq $VERSION (find existing binaries on <https://github.com/mikefarah/yq/releases/$VERSION>)"
            exit 1
          fi
        fi
        echo "BINARY=$BINARY" >>"$GITHUB_ENV"
        echo "Using yq binary \"$BINARY\""
      shell: bash

    - name: install
      run: |
        url=https://github.com/mikefarah/yq/releases/download/"$VERSION"/"$BINARY"
        echo "Installing yq $VERSION from $url"
        sudo wget -q -O /usr/local/bin/yq "$url" && sudo chmod +x /usr/local/bin/yq
      shell: bash

    - name: verify
      run: |
        echo "Verifying installation"
        if ! stderr=$(yq 2>&1 >/dev/null); then
          echo "::error::$stderr"
          exit 1
        fi
        echo "Installation of yq successful"
      shell: bash
